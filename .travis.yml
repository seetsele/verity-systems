# Verity Systems - Travis CI Configuration
# Continuous Integration for AI Fact-Checking Platform
# GitHub Education: Free for open source projects

language: python
python:
  - "3.10"
  - "3.11"

# Cache pip dependencies for faster builds
cache:
  pip: true
  directories:
    - $HOME/.cache/pip
    - node_modules

# Environment variables (non-sensitive defaults)
env:
  global:
    - ENVIRONMENT=test
    - PYTHONDONTWRITEBYTECODE=1

# Services (if needed)
# services:
#   - redis-server

# Install dependencies
install:
  - pip install --upgrade pip
  - pip install -r python-tools/requirements.txt
  - pip install pytest pytest-asyncio pytest-cov httpx

# Run tests with coverage
script:
  # Run Python tests with coverage
  - pytest python-tools/ -v --cov=python-tools --cov-report=xml --cov-report=term
  
  # Check for Python syntax errors
  - python -m py_compile python-tools/*.py
  
  # Optional: Run security checks
  # - pip install bandit safety
  # - bandit -r python-tools/ -ll
  # - safety check

# Upload coverage to Codecov
after_success:
  - bash <(curl -s https://codecov.io/bash) -t $CODECOV_TOKEN

# Notifications (optional)
notifications:
  email:
    on_success: never
    on_failure: always
  # Slack integration (optional)
  # slack:
  #   secure: "your_encrypted_slack_webhook"

# Build stages for more control
stages:
  - lint
  - test
  - deploy

jobs:
  include:
    # Linting stage
    - stage: lint
      name: "Python Linting"
      python: "3.11"
      script:
        - pip install flake8 black isort
        - flake8 python-tools/ --max-line-length=120 --ignore=E501,W503
        # - black --check python-tools/
        # - isort --check-only python-tools/
    
    # Test stages for multiple Python versions
    - stage: test
      name: "Python 3.10 Tests"
      python: "3.10"
    
    - stage: test
      name: "Python 3.11 Tests"
      python: "3.11"
    
    # Security scan stage
    - stage: test
      name: "Security Scan"
      python: "3.11"
      script:
        - pip install safety bandit
        - safety check --full-report || true
        - bandit -r python-tools/ -ll || true
    
    # Deploy stage (only on main branch)
    - stage: deploy
      name: "Deploy to Vercel"
      python: "3.11"
      if: branch = main AND type != pull_request
      script:
        - echo "Deployment would happen here"
        # - npm i -g vercel
        # - vercel --prod --token $VERCEL_TOKEN

# Matrix configuration
# Allow some jobs to fail without failing the entire build
matrix:
  fast_finish: true
  allow_failures:
    - name: "Security Scan"

# Branch configuration
branches:
  only:
    - main
    - develop
    - /^feature\/.*$/
    - /^hotfix\/.*$/
